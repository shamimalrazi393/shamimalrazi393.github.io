<!-- BEGINNING OF YOUR FILE — HEAD AND BODY UNCHANGED — SCROLL TO SCRIPT BELOW -->

<!-- YOUR EXISTING PAGE CONTENT REMAINS UNCHANGED -->

<script>
  const DRIVE_UPLOAD_URL = "https://script.google.com/macros/s/AKfycbzFPc-oOl6sBB0khxc_2rd2MxDEB8nujcxxd4-xB65amh3qFhJGzK8RmF4wLaj9Rpch/exec";
  let isAuthorLoggedIn = false;

  // Author credentials
  let AUTHOR_ID = localStorage.getItem("author_id") || "admin";
  let AUTHOR_PASSWORD = localStorage.getItem("author_pass") || "123456";

  // Replace upload function to use Drive
  async function uploadFile(inputId, section) {
    if (!isAuthorLoggedIn) {
      alert("Please login as author to upload.");
      return;
    }

    const input = document.getElementById(inputId);
    const file = input.files[0];
    if (!file) return alert("Please select a file first.");

    const formData = new FormData();
    formData.append("file", file);
    formData.append("section", section);

    try {
      const res = await fetch(DRIVE_UPLOAD_URL, {
        method: "POST",
        body: formData,
      });
      const result = await res.json();
      if (result.success) {
        alert(`Uploaded '${file.name}' successfully.`);
        input.value = "";
        loadDriveFiles();
      } else {
        alert("Upload failed.");
      }
    } catch (err) {
      alert("Upload error.");
      console.error(err);
    }
  }

  // Fetch files from Drive by section
  async function loadDriveFiles() {
    const sections = ["fusion", "publications", "writings"];
    for (const section of sections) {
      const container = document.getElementById(
        section === "publications"
          ? "publication-files"
          : section === "writings"
          ? "writing-files"
          : "fusion-files"
      );
      container.textContent = "Loading...";

      try {
        const res = await fetch(`${DRIVE_UPLOAD_URL}?section=${section}`);
        const files = await res.json();
        if (!Array.isArray(files) || files.length === 0) {
          container.textContent = "No files uploaded.";
          continue;
        }

        container.innerHTML = "";
        files.forEach((file) => {
          const div = document.createElement("div");
          div.className = "file-item";

          const a = document.createElement("a");
          a.href = file.url;
          a.target = "_blank";
          a.rel = "noopener";
          a.textContent = file.name;

          div.appendChild(a);

          if (isAuthorLoggedIn) {
            const btn = document.createElement("button");
            btn.textContent = "Delete";
            btn.onclick = () => deleteDriveFile(file.id, section);
            div.appendChild(btn);
          }

          container.appendChild(div);
        });
      } catch (err) {
        container.textContent = "Failed to load files.";
        console.error(err);
      }
    }
  }

  // Delete file from Drive
  async function deleteDriveFile(fileId, section) {
    if (!isAuthorLoggedIn) {
      alert("Please login as author to delete files.");
      return;
    }
    if (!confirm("Are you sure you want to delete this file?")) return;

    try {
      const res = await fetch(DRIVE_UPLOAD_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ mode: "delete", fileId }),
      });
      const result = await res.json();
      if (result.success) {
        alert("File deleted.");
        loadDriveFiles();
      } else {
        alert("Delete failed.");
      }
    } catch (err) {
      alert("Delete error.");
      console.error(err);
    }
  }

  // Author login check
  function checkAuthorLogin() {
    const id = document.getElementById("author-id").value.trim();
    const pass = document.getElementById("author-password").value.trim();
    if (id === AUTHOR_ID && pass === AUTHOR_PASSWORD) {
      isAuthorLoggedIn = true;
      alert("Login successful!");
      toggleLoginUI();
      loadDriveFiles();
    } else {
      alert("Invalid credentials.");
    }
  }

  // Sign out author
  function signOutAuthor() {
    isAuthorLoggedIn = false;
    toggleLoginUI();
    loadDriveFiles();
  }

  // UI toggling
  function toggleLoginUI() {
    document.getElementById("author-login").style.display = isAuthorLoggedIn ? "none" : "block";
    document.getElementById("author-logout").style.display = isAuthorLoggedIn ? "block" : "none";
    document.getElementById("change-pass-section").style.display = isAuthorLoggedIn ? "block" : "none";

    document.querySelectorAll(".upload-author-only").forEach((el) => {
      el.style.display = isAuthorLoggedIn ? "block" : "none";
    });

    if (!isAuthorLoggedIn) {
      document.getElementById("author-id").value = "";
      document.getElementById("author-password").value = "";
    }
  }

  // Change credentials
  function changeAuthorCredentials() {
    if (!isAuthorLoggedIn) {
      alert("Please login first.");
      return;
    }
    const newId = document.getElementById("new-author-id").value.trim();
    const newPass = document.getElementById("new-author-pass").value.trim();
    if (newId.length < 3 || newPass.length < 3) {
      alert("Author ID and Password must be at least 3 characters.");
      return;
    }
    if (!confirm("Change Author ID and Password? You will be logged out after this.")) return;

    AUTHOR_ID = newId;
    AUTHOR_PASSWORD = newPass;
    localStorage.setItem("author_id", AUTHOR_ID);
    localStorage.setItem("author_pass", AUTHOR_PASSWORD);

    alert("Author credentials changed. Please log in again.");
    signOutAuthor();
    document.getElementById("new-author-id").value = "";
    document.getElementById("new-author-pass").value = "";
  }

  // YouTube Loader (unchanged)
  function fetchVideos() {
    const channelId = "UCZpabp4C9ttk68-G1_SOsJQ";
    const apiKey = "AIzaSyC0Z9fSpsm-GUipCRgG0XJTeKTvRza0pFU";
    fetch(`https://www.googleapis.com/youtube/v3/search?key=${apiKey}&channelId=${channelId}&part=snippet,id&order=date&maxResults=4`)
      .then(res => res.json())
      .then(data => {
        const videosDiv = document.getElementById('youtube-videos');
        videosDiv.innerHTML = '';
        if (!data.items) return videosDiv.textContent = 'No videos found.';
        data.items.forEach(item => {
          if (item.id.kind === "youtube#video") {
            const iframe = document.createElement('iframe');
            iframe.width = "320";
            iframe.height = "180";
            iframe.src = `https://www.youtube.com/embed/${item.id.videoId}`;
            iframe.allowFullscreen = true;
            videosDiv.appendChild(iframe);
          }
        });
      })
      .catch(() => {
        document.getElementById('youtube-videos').textContent = 'Failed to load videos.';
      });
  }

  // Load page
  window.onload = () => {
    fetchVideos();
    toggleLoginUI();
    loadDriveFiles();
  };
</script>
